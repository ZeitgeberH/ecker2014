function fig3_ve
% Fig. 3: Variance explained by one-factor GPFA model.
%   Here we compute percent variance explained on the test set for the one-
%   factor GPFA model for each cell as a function of both firing rates and
%   brain state.
%
% AE 2013-08-28

% key for analysis parameters
keys.project_name = 'NoiseCorrAnesthesia';
keys.sort_method_num = 5;
keys.spike_count_start = 30;
keys.max_instability = 0.1;
keys.min_trials = 20;
keys.min_cells = 10;
keys.max_contam = 1;
keys.bin_size = 100;
keys.transform_num = 5;
keys.max_latent_dim = 1;
keys.latent_dim = 1;
keys.kfold_cv = 2;
keys.zscore = false;
keys.control = 0;
keys.int_bins = 5;
keys = genKey(keys, 'state', flipud(unique(fetchn(nc.Anesthesia, 'state'))));
keys(3) = keys(2);
keys(3).control = 1;   % control analysis for anesthetized data (first 500 ms only)

fig = Figure(4, 'size', [100 100]);
M = 2; N = 2;
n = numel(keys);
frbins = -1 : 7;
scax = [-1 8 -0.5 1];
bax = [frbins([1 end]) 0 0.4];
intbins = [1 2 5 10 20];
ints = pro(nc.Integers, 'x -> int_bins') & sprintf('int_bins IN (0%s)', sprintf(', %d', intbins));
linestyle = {'.-', '.-', '.:'};

for i = 1 : n

    rel = nc.AnalysisStims * nc.GpfaParams * nc.GpfaModelSet * nc.GpfaVE * nc.UnitStatsConditions;
    [ve, fr] = fetchn(rel & keys(i), 've_test', 'mean_rate_cond');

    % scatter plots: variance explained vs. firing rate
    if i < 3
        subplot(M, N, i)
        plot(log2(fr), ve, '.', 'color', colors(keys(i).state), 'markersize', 1)
        axis square
        axis(scax)
        set(gca, 'xticklabel', 2 .^ get(gca, 'xtick'))
        xlabel('Firing raten (spikes/s)')
        if i == 1
            ylabel('Variance explained')
        end
    end
    
    % binned average VE as a function of firing rate
    subplot(M, N, 3)
    hold on
    [m, se, frbinsc] = makeBinned(log2(fr), ve, frbins, @mean, @(x) std(x) / sqrt(numel(x)), 'include');
    errorbar(frbinsc, m, se, linestyle{i}, 'color', colors(keys(i).state))
    axis square
    axis(bax)
    set(gca, 'xticklabel', 2 .^ get(gca, 'xtick'))
    xlabel('Firing rate (spikes/s)')
    ylabel('Average variance explained')

    % VE as a function of integration window
    subplot(M, N, 4)
    hold on
    rel = nc.AnalysisStims * nc.GpfaParams * nc.GpfaModelSet * nc.GpfaVE;
    [t, v, se] = fetchn(ints, rel & rmfield(keys(i), 'int_bins'), 'int_bins', 'AVG(ve_test) -> ve', 'STD(ve_test) / SQRT(COUNT(1)) -> se');
    t = t * keys(1).bin_size;
    errorbar(t, v, se, linestyle{i}, 'color', colors(keys(i).state))
    set(gca, 'xscale', 'log', 'xlim', intbins([1 end]) * keys(1).bin_size, ...
        'xtick', intbins * keys(1).bin_size, 'xminortick', 'off', 'ylim', [0 0.15001])
    xlabel('Integration window (ms)')
    axis square
end

subplot(M, N, 4)
set(legend(keys.state), 'location', 'east')

fig.cleanup()

file = strrep(mfilename('fullpath'), 'code', 'figures');
fig.save(file)
